<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h1>
      Сравнение открытых OLAP-систем Big Data: ClickHouse, Druid и&nbsp;Pinot
    </h1>

    <p>
      <a href="#">ClickHouse</a>, <a href="#">Druid</a> и
      <a href="#">Pinot</a>&nbsp;&mdash; три открытых хранилища данных, которые
      позволяют выполнять аналитические запросы на&nbsp;больших объемах данных
      с&nbsp;интерактивными задержками. Эта статья&nbsp;&mdash; перевод
      <a href="#">подробного сравнения</a>, выполненного Романом Левентовым.
    </p>
    <h3>Источники информации</h3>
    <p>
      Подробности реализации <b>ClickHouse</b> стали мне известны от
      <a href="#">Алексея Зателепина</a>, одного из
      <b>ключевых разработчиков проекта</b>. Доступная на&nbsp;английском
      документация достаточно скудна&nbsp;&mdash; наилучшим источником
      информации служат последние четыре секции
      <a href="#">данной страницы документации</a>.
    </p>
    <p>
      <b>Я&nbsp;сам участвую в&nbsp;развитии Druid</b>, но&nbsp;у&nbsp;меня нет
      личной заинтересованности в&nbsp;этой системе&nbsp;&mdash; по&nbsp;правде
      говоря, скорее всего в ближайшее время я&nbsp;перестану заниматься
      её&nbsp;разработкой. Поэтому читатели могут рассчитывать
      на&nbsp;отсутствие какой-либо предвзятости.
    </p>
    <p>
      Всё, что я&nbsp;буду далее писать про <b>Pinot</b>, основывается
      на&nbsp;странице <a href="#">Архитектура в&nbsp;вики Pinot</a>,
      а&nbsp;также на&nbsp;других страницах вики в&nbsp;разделе &laquo;Проектная
      документация&raquo;. Последний раз они обновлялись в&nbsp;июне 2017
      года&nbsp;&mdash; больше, чем полгода назад.
    </p>
    <p>
      Рецензентами оригинальной статьи стали Алексей Зателепин и
      <a href="#">Виталий Людвиченко</a> (разработчики ClickHouse),
      <a href="#">Жан Мерлино</a>
      (самый активный разработчик Druid),
      <a href="#">Кишор Гопалакришна</a> (архитектор Pinot) и
      <a href="#">Жан-Француа Им</a>
      (разработчик Pinot). Мы&nbsp;присоединяемся к&nbsp;благодарности автора
      и&nbsp;полагаем, что это многократно повышает авторитетность статьи.
    </p>
    <p>
      <b>Предупреждение</b>: статья достаточно большая, поэтому вполне возможно
      вы&nbsp;захотите ограничиться прочтением раздела &laquo;Заключение&raquo;
      в конце.
    </p>
    <h2>Сходства между системами</h2>
    <h3>Связанные данные и&nbsp;вычисления</h3>
    <p>
      <b
        >На&nbsp;фундаментальном уровне, ClickHouse, Druid и&nbsp;Pinot
        похожи</b
      >, поскольку они хранят данные и&nbsp;выполняют обработку запросов
      на&nbsp;одних и&nbsp;тех же&nbsp;узлах, уходя
      от&nbsp;&laquo;разъединенной&raquo; архитектуры BigQuery. Недавно
      я&nbsp;уже описывал несколько наследственных проблем со&nbsp;связанной
      архитектурой в&nbsp;случае Druid [<a href="#">1</a>, <a href="#">2</a>].
      Открытого эквивалента для BigQuery на&nbsp;данный момент
      не&nbsp;существует (за исключением, разве что, <a href="#">Drill</a>?)
      Возможным подходам к построению подобных открытых систем посвящена
      <a href="#">другая статье в&nbsp;моем блоге</a>.
    </p>
    <h3>
      Отличия от&nbsp;Big Data SQL-систем: индексы и&nbsp;статическое
      распределение данных
    </h3>
    <p>
      Рассматриваемые в&nbsp;этой статье системы
      <b>выполняют запросы быстрее</b>, чем системы Big Data из&nbsp;семейства
      класса SQL-on-Hadoop: Hive, Impala, Presto и&nbsp;Spark, даже когда
      последние получают доступ к&nbsp;данным, хранящимся в&nbsp;колоночном
      формате&nbsp;&mdash; к&nbsp;примеру, Parquet или Kudu. Это происходит
      потому, что в&nbsp;ClickHouse, Druid и&nbsp;Pinot:
    </p>
    <ul>
      <li>
        Имеется
        <b>свой собственный формат для хранения данных с&nbsp;индексами</b>,
        и&nbsp;они тесно интегрированы с&nbsp;движками обработки запросов.
        Системы класса SQL-on-Hadoop обычно можно назвать агностиками
        относительно форматов данных и&nbsp;поэтому они менее
        &laquo;навязчивы&raquo; в&nbsp;бэкендах Big Data.
      </li>
      <li>
        <b>Данные распределены относительно &laquo;статично&raquo;</b> между
        узлами, и&nbsp;при распределенном выполнении запроса это можно
        использовать. Обратная сторона медали при этом в&nbsp;том, что
        ClickHouse, Druid и&nbsp;Pinot
        <b
          >не&nbsp;поддерживают запросы, которые требуют перемещения большого
          количества данных</b
        >
        между узлами&nbsp;&mdash; к&nbsp;примеру, join между двумя большими
        таблицами.
      </li>
    </ul>
    <h3>Отсутствие точечных обновлений и&nbsp;удалений</h3>
    <p>
      Находясь на&nbsp;другой стороне спектра баз данных, ClickHouse, Druid
      и&nbsp;Pinot
      <b>не&nbsp;поддерживают точечные обновления и&nbsp;удаления</b>,
      в&nbsp;противоположность колоночным системам вроде Kudu, InfluxDB
      и&nbsp;Vertica (?). Это даёт ClickHouse, Druid и&nbsp;Pinot возможность
      производить более эффективное колоночное сжатие и&nbsp;более агрессивные
      индексы, что означает
      <b>большую эффективность использования ресурсов</b> и&nbsp;быстрое
      выполнение запросов.
    </p>
    <p>
      Разработчики ClickHouse в&nbsp;Yandex планируют начать поддерживать
      <a href="#">обновления и&nbsp;удаления в&nbsp;будущем</a>,
      но&nbsp;я&nbsp;не&nbsp;уверен, будут&nbsp;ли это &laquo;настоящие&raquo;
      точечные запросы или обновления/удаления диапазонов данных.
    </p>
    <h3>Поглощение в&nbsp;стиле Big Data</h3>
    <p>
      Все три системы поддерживают потоковое поглощение данных из&nbsp;Kafka.
      Druid и Pinot поддерживают потоковую передачу данных стриминг в
      <a href="#">Лямбда-стиле</a> и&nbsp;пакетное поглощение одних
      и&nbsp;тех&nbsp;же данных. ClickHouse поддерживает пакетные вставки
      напрямую, поэтому ему не требуется отдельная система пакетного поглощения
      подобная той, что используется в&nbsp;Druid и&nbsp;Pinot. Если вас
      интересуют подробности, то&nbsp;их&nbsp;вы сможете найти далее.
    </p>
    <h3>Проверено на&nbsp;крупном масштабе</h3>
    <p>
      Все три системы проверены на&nbsp;работоспособность в&nbsp;крупных
      масштабах: в
      <a href="#">Yandex.Metrica работает кластер ClickHouse</a>, состоящий из
      примерно десятка тысяч ядер CPU. В&nbsp;Metamarkets используется
      <a href="#">кластер Druid аналогичного размера</a>. Один кластер Pinot в
      LinkedIn включает в&nbsp;себя &laquo;<a href="#">тысячи машин</a>&raquo;.
    </p>
    <h3>Незрелость</h3>
    <p>
      Все рассматриваемые в&nbsp;статье системы являются
      <b>незрелыми по&nbsp;меркам открытых enterprise-систем Big Data</b>.
      Однако, скорее всего они незрелы не&nbsp;более, чем среднестатистическая
      открытая система Big Data&nbsp;&mdash; но&nbsp;это совсем другая история.
      В ClickHouse, Druid и&nbsp;Pinot недостает некоторых очевидных оптимизаций
      и функциональности, и&nbsp;они кишат багами (насчет ClickHouse
      и&nbsp;Pinot я&nbsp;не&nbsp;уверен на&nbsp;все 100%, но&nbsp;не&nbsp;вижу
      причин, по&nbsp;которым они в&nbsp;этом плане были&nbsp;бы лучше Druid).
    </p>
    <p>Это плавно подводит нас к&nbsp;следующему важному разделу.</p>
    <h2>Про сравнение производительности и&nbsp;выбор системы</h2>
    <p>
      Я&nbsp;регулярно вижу в&nbsp;сети, как некоторые проводят сравнения систем
      больших данных: они берут набор своих данных, каким-либо образом
      &laquo;скармливают&raquo; его оцениваемой системе, а&nbsp;затем немедленно
      пытаются измерить производительность&nbsp;&mdash; сколько памяти или
      дискового пространства было занято, и&nbsp;насколько быстро выполнялись
      запросы. Причем понимание того, как устроены изнутри испытываемые ими
      системы, у них отсутствует. Затем, используя лишь подобные специфичные
      данные о производительности&nbsp;&mdash; иногда вместе со&nbsp;списками
      функциональности, которая им нужна и&nbsp;которая есть в&nbsp;системе
      на&nbsp;настоящий момент,&nbsp;&mdash; они в&nbsp;итоге делают свой выбор
      или, что еще хуже, выбирают написать свою собственную,
      &laquo;лучшую&raquo; систему с нуля.
    </p>
    <p>
      Такой подход мне кажется неправильным, по&nbsp;крайней мере
      он&nbsp;неприменим в отношении открытых OLAP-систем для Big Data. Задача
      создания системы Bid Data OLAP, которая смогла&nbsp;бы работать эффективно
      в&nbsp;большинстве сценариев использования и&nbsp;содержала&nbsp;бы все
      необходимые функции настолько велика, что я оцениваю ее&nbsp;реализацию
      как минимум в&nbsp;<b>100 человеко-лет</b>.
    </p>
    <p>
      На&nbsp;сегодня, ClickHouse, Druid и&nbsp;Pinot оптимизированы только для
      конкретных сценариев использования, которые требуются
      их&nbsp;разработчиком&nbsp;&mdash; и&nbsp;содержат по большей части лишь
      те&nbsp;функции, в&nbsp;которых нуждаются сами разработчики. Я&nbsp;могу
      гарантировать, что ваш случай обязательно &laquo;упрется&raquo;
      в&nbsp;те&nbsp;узкие места, с&nbsp;которыми разработчики рассматриваемых
      OLAP-систем еще не&nbsp;сталкивались&nbsp;&mdash; или&nbsp;же в&nbsp;те
      места, что их&nbsp;не&nbsp;интересуют.
    </p>
    <p>
      Не говоря уже о&nbsp;том, что упомянутый выше подход &laquo;забросить
      данные в&nbsp;систему, о которой вы&nbsp;ничего не&nbsp;знаете,
      и&nbsp;затем измерить её&nbsp;эффективность&raquo; весьма вероятно даст
      искаженный результат из-за серьезных &laquo;узких&raquo; мест, которые
      на&nbsp;самом деле могли&nbsp;бы быть исправлены
      <b>простым изменением конфигурации</b>, схемы данных или другим
      построением запроса.
    </p>
    <h3>CloudFlare: ClickHouse против Druid</h3>
    <p>
      Одним таким примером, хорошо иллюстрирующим описанную выше проблему,
      является пост Марека Вавруша о&nbsp;
      <a href="#">выборе между ClickHouse и&nbsp;Druid в&nbsp;Cloudflare</a>. Им
      потребовалось 4&nbsp;сервера ClickHouse (которые со&nbsp;временем
      превратились в&nbsp;9), и&nbsp;по&nbsp;их оценкам, для разворачивания
      аналогичной установки Druid им&nbsp;бы потребовались &laquo;сотни
      узлов&raquo;. Пусть Марек и&nbsp;признает, что
      <b>сравнение является нечестным</b>, поскольку Druid недостаёт
      &laquo;сортировки по&nbsp;первичному ключу&raquo;, он&nbsp;возможно даже
      не осознает, что достичь примерно того&nbsp;же самого эффекта в&nbsp;Druid
      возможно просто
      <a href="#"
        >установив правильный порядок измерений в&nbsp;&laquo;ingestion
        spec&raquo;</a
      >
      и&nbsp;произведя простую подготовку данных: обрезать значение колонки
      <code>__time</code> в&nbsp;Druid до&nbsp;некоей грубой детализации
      (к&nbsp;примеру, один час) и&nbsp;опционально добавить другую
      &laquo;длинно-типовую&raquo; колонку &laquo;precise_time&raquo;, если для
      некоторых запросов требуются более точные временные рамки. Да, это хак,
      но, как мы&nbsp;только что выяснили, и&nbsp;в&nbsp;Druid можно сортировать
      данные по&nbsp;какому-либо измерению перед <code>__time</code>, и&nbsp;это
      достаточно просто реализовать.
    </p>
    <p>
      Впрочем, я&nbsp;не&nbsp;стану спорить с&nbsp;их&nbsp;итоговым решением
      выбрать ClickHouse, поскольку на&nbsp;масштабе примерно
      в&nbsp;10&nbsp;узлов и&nbsp;для их&nbsp;нужд ClickHouse мне тоже кажется
      лучшим выбором, чем Druid. Но&nbsp;сделанное ими заключение о&nbsp;том,
      что ClickHouse как минимум на&nbsp;порядок эффективнее (по&nbsp;меркам
      стоимости инфраструктуры), чем Druid&nbsp;&mdash; это серьезное
      заблуждение. На&nbsp;самом деле, из&nbsp;рассматриваемых нами сегодня
      систем,
      <b
        >Druid предлагает наилучшую возможность для реально дешевых установок</b
      >
      (смотрите раздел &laquo;Уровни узлов обработки запросов в&nbsp;Druid
      &raquo; ниже).
    </p>
    <mark>
      Когда вы&nbsp;выбираете систему OLAP Big Data,
      не&nbsp;сравнивайте&nbsp;то, насколько они сейчас хорошо подходят для
      вашего случая. Сейчас они все субоптимальны. Вместо этого, сравните,
      насколько быстро ваша компания способна заставить двигаться эти системы
      в&nbsp;том направлении, которое нужно именно вам.
    </mark>
    <p>
      В&nbsp;силу своей фундаментальной архитектурной схожести, ClickHouse,
      Druid и&nbsp;Pinot имеют примерно один и&nbsp;тот&nbsp;же
      &laquo;предел&raquo; эффективности и&nbsp;оптимизации производительности.
      Здесь нет &laquo;волшебной таблетки&raquo;, которая позволила&nbsp;бы
      какой- либо из&nbsp;этих систем быть быстрее, чем остальные.
      Не&nbsp;позволяйте запутать себя тем фактом, что в&nbsp;своем текущем
      состоянии системы показывают себя очень по-разному в&nbsp;различных
      бенчмарках.
    </p>
    <p>
      Допустим, Druid не&nbsp;поддерживает &laquo;сортировку по&nbsp;первичному
      ключу&raquo; настолько хорошо, насколько это умеет ClickHouse&nbsp;&mdash;
      а&nbsp;ClickHouse в&nbsp;свою очередь не поддерживает
      &laquo;инвертированные индексы&raquo; столь&nbsp;же хорошо, как Druid, что
      дает данным системам преимущества с&nbsp;той или иной нагрузкой.
      <b
        >Упущенные оптимизации могут быть реализованы в&nbsp;выбранной системе
        при помощи не&nbsp;таких уж&nbsp;и больших усилий </b
      >, если у&nbsp;вас есть намерение и&nbsp;возможность решиться
      на&nbsp;подобный шаг.
    </p>
    <ul>
      <li>
        В вашей организации должны быть инженеры, способные прочитать, понять и
        модифицировать исходный код выбранной системы, к&nbsp;тому&nbsp;же
        у&nbsp;них должно быть на&nbsp;это время. Заметьте, что ClickHouse
        написан на&nbsp;C++, а&nbsp;Druid и&nbsp;Pinot &mdash; на&nbsp;Java.
      </li>
      <li>
        Или&nbsp;же ваша организация должна подписать контракт с&nbsp;компанией,
        которая оказывает поддержку выбранной системы. Это будут
        <a href="#">Altinity</a> для ClickHouse, <a href="#">Imply</a> и&nbsp;<a
          href="#"
          >Hortonworks</a
        >
        для Druid. Для Pinot таких компаний в&nbsp;данный момент нет.
      </li>
    </ul>
    <p>
      Другие сведения о&nbsp;разработке систем, которые вам стоит принять
      во&nbsp;внимание:
    </p>
    <ul>
      <li>
        Авторы ClickHouse, работающие в&nbsp;Yandex, утверждают, что они
        тратят&nbsp;50% своего времени на&nbsp;создание функциональности,
        которая требуется им&nbsp;внутри компании, и&nbsp;другие&nbsp;50% уходят
        на&nbsp;функции, который набирают большинство &laquo;голосов
        сообщества&raquo;. Однако, чтобы вы&nbsp;получили от&nbsp;этого факта
        преимущество, требуется, чтобы
        <b
          >функции, которые нужны вам, были и наиболее востребованы
          сообществом</b
        >
        ClickHouse.
      </li>
      <li>
        Разработчики Druid из&nbsp;Imply мотивированы работать над широко
        используемыми функциями, поскольку это позволит им&nbsp;максимально
        увеличить объем охвата своего бизнеса в&nbsp;будущем.
      </li>
      <li>
        Процесс разработки Druid сильно напоминает
        <a href="#">модель Apache</a>, когда&nbsp;ПО несколько лет
        разрабатывается несколькими компаниями, у&nbsp;каждой из&nbsp;который
        достаточно своеобразные и&nbsp;различные приоритеты, и&nbsp;среди них
        нет ведущей компании. ClickHouse и&nbsp;Pinot пока еще далеки
        от&nbsp;подобного этапа, поскольку ими занимаются соответственно лишь
        Yandex и&nbsp;Linkedin. Сторонний вклад в развитие Druid имеет
        минимальный шанс быть отклоненным в&nbsp;силу того, что он расходится
        с&nbsp;видением основного разработчика&nbsp;&mdash; ведь
        <b>в&nbsp;Druid нет &laquo;основной&raquo; компании-разработчика</b>.
      </li>
      <li>
        Druid поддерживает &laquo;API разработчика&raquo;, который позволяет
        привносить собственные типы колонок, механизмы агрегации, возможные
        варианты для &laquo;глубокого хранения&raquo; и&nbsp;пр., причем все это
        вы&nbsp;можете держать в&nbsp;кодовой базе, отдельной от&nbsp;самого
        ядра Druid. Данное API документировано разработчиками Druid, и&nbsp;они
        следят за&nbsp;его совместимостью с&nbsp;предыдущими версиями. Однако,
        оно недостаточно &laquo;взрослое&raquo;, и&nbsp;ломается практически
        с&nbsp;каждым новым релизом Druid. Насколько мне известно,
        в&nbsp;ClickHouse и&nbsp;Pinot схожие API не поддерживаются.
      </li>
      <li>
        Согласно Github,
        <b>над Pinot работает наибольшее число людей</b>&nbsp;&mdash;
        по&nbsp;всей видимости, лишь за&nbsp;прошлый год в&nbsp;Pinot было
        вложено <a href="#">не&nbsp;менее 10&nbsp;человеко-лет</a>. Для
        ClickHouse эта цифра составляет примерно 6&nbsp;человеко-лет, а&nbsp;для
        Druid&nbsp;&mdash; 7. В&nbsp;теории, это должно означать, что Pinot
        улучшается быстрее всех остальных систем, которые мы&nbsp;рассматриваем.
      </li>
    </ul>
  </body>
</html>
